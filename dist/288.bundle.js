export const __webpack_esm_id__=288;export const __webpack_esm_ids__=[288];export const __webpack_esm_modules__={1752(t,e,r){r.d(e,{SQ:()=>i,YL:()=>o});var a=r(5656),s=r(7140);const n=(0,s.createContext)(void 0),o=({children:t})=>{const[e,r]=(0,s.useState)(""),o=(0,s.useCallback)(t=>{r(t)},[]);return(0,a.jsx)(n.Provider,{value:{searchQuery:e,setSearchQuery:o},children:t})},i=()=>{const t=(0,s.useContext)(n);if(!t)throw new Error("useSearch cannot be used outside of SearchProvider");return t}},3228(t,e,r){r.a(t,async(t,a)=>{try{r.d(e,{eS:()=>D,r8:()=>I,yG:()=>f,yN:()=>m});var s=r(5822).V;const{characters:n,getRequestHeaders:o,getThumbnailUrl:i,system_avatar:c,openCharacterChat:u,setActiveCharacter:l,setActiveGroup:p,getCurrentChatId:h,saveSettingsDebounced:E,selectCharacterById:d}=await s("@script"),{groups:_,openGroupById:T,openGroupChat:C}=await s("@scripts/groupChats"),{sortMoments:g,timestampToMoment:S,isDataURL:A}=await s("@scripts/utils");async function I(t,e=20){const r=await fetch("/api/chats/recent",{method:"POST",headers:o(),body:JSON.stringify({max:e})});if(!r.ok)return console.warn("Failed to fetch recent character chats"),[];const a=await r.json();if(!Array.isArray(a)||0===a.length)return[];const s=a.sort((t,e)=>g(S(t.last_mes),S(e.last_mes))).map(t=>({chat:t,character:n.find(e=>e.avatar===t.avatar),group:_.find(e=>e.id===t.group)})).filter(t=>t.character||t.group).filter(e=>{if(!t||0===t.length)return!0;return!!t.find(t=>e.character&&"character"===t.type&&t.item.avatar.toString()===e.character.avatar?.toString()||e.group&&"group"===t.type&&t.id.toString()===e.group.id.toString())});return s.forEach(({chat:t,character:e,group:r},a)=>{const s=S(t.last_mes);t.char_name=e?.name||r?.name||"",t.date_short=s.format("l"),t.date_long=s.format("LL LT"),t.chat_name=t.file_name.replace(".jsonl",""),t.char_thumbnail=e?i("avatar",e?.avatar??""):c,t.is_group=!!r,t.hidden=a>=15,t.avatar=t.avatar||"",t.group=t.group||"",t.char_id=e?n.indexOf(e):void 0}),s.map(t=>t.chat)}const f=async(t,e)=>{try{if(await d(t),l(t),E(),h()===e||!e)return;await u(e)}catch(t){console.error("Error selecting character:",t)}},D=async({group:t,chat_id:e,id:r})=>{try{if(!t&&!r)return;const a=r||t?.id.toString()||"";if(!a)return;if(await T(a),p(a),E(),!e||h()===e)return;await C(a,e)}catch(t){console.error("Error selecting group:",t)}},m=({chat:t,charId:e,groupId:r})=>{if(t&&t?.avatar)return i("avatar",t?.avatar);if(e||r||(e=SillyTavern.getContext().characterId,r=SillyTavern.getContext().groupId),null!=r){return SillyTavern.getContext().groups.find(t=>t.id.toString()===r.toString()).avatar_url}const a="string"==typeof e?parseInt(e):e??-1,s=SillyTavern.getContext().characters[a];return s?i("avatar",s.avatar||""):c};a()}catch(y){a(y)}},1)},3696(t,e,r){r.d(e,{V:()=>a});const a={HOME_BUTTON_CLICKED:"DISCORDIA_HOME_BUTTON_CLICKED",ENTITY_DELETED:"DISCORDIA_ENTITY_DELETED",CHAT_UPDATE:"DISCORDIA_CHAT_UPDATE",ICONS_UPDATE:"DISCORDIA_ICONS_UPDATE",ENTITY_CHANGED:"DISCORDIA_ENTITY_CHANGED",CHAT_SWITCH_PENDING:"DISCORDIA_CHAT_SWITCH_PENDING"}},5288(t,e,r){r.a(t,async(t,a)=>{try{r.r(e),r.d(e,{App:()=>E,default:()=>d});var s=r(5656),n=r(7140),o=r(5219),i=r(5902),c=r(1752),u=r(21),l=t([i]),p=l.then?(await l)():l;i=p[0];const h=(0,n.lazy)(()=>r.e(745).then(r.bind(r,1745))),E=()=>{const t=(0,i.p)(),e=(0,n.useMemo)(()=>t,[t.open,t.setOpen,t.entities,t.chats,t.icons,t.isLoadingChats,t.isInitialLoad]);return(0,o.createPortal)((0,s.jsx)(c.YL,{children:(0,s.jsx)(h,{...e})}),u.o)},d=E;a()}catch(t){a(t)}})},5822(t,e,r){r.d(e,{V:()=>o});let a=null,s=!1;const n=(t,e)=>e?t.startsWith("../")?`../../../../../public/${t.slice(3)}`:`../../../../../public/scripts/${t}`:`../../../../${t}`,o=async t=>{s&&null!==a||await(async()=>{if(s)return;let t=!1;try{const e="../../../../../script.js",r=await import(e);r||Object.keys(r).length||(t=!0)}catch{t=!0}a={"@script":n("../script.js",t),"@scripts/groupChats":n("group-chats.js",t),"@scripts/utils":n("utils.js",t),"@scripts/welcomeScreen":n("welcome-screen.js",t),"@scripts/personas":n("personas.js",t),"@scripts/chats":n("chats.js",t),"@scripts/powerUser":n("power-user.js",t),"@scripts/extensions":n("extensions.js",t),"@scripts/worldInfo":n("world-info.js",t),"@scripts/naiSettings":n("nai-settings.js",t),"@scripts/openai":n("openai.js",t),"@scripts/kaiSettings":n("kai-settings.js",t),"@scripts/horde":n("horde.js",t),"@scripts/textGenSettings":n("textgen-settings.js",t),"@scripts/presetManager":n("preset-manager.js",t),"@scripts/secrets":n("secrets.js",t)},s=!0,console.log(`[SillyTavern-Discordia] Running as ${t?"local":"global"} extension.`)})();try{const e=a[t]||t;return await import(e)}catch(e){return console.error(`Error importing ${t} (${a[t]}):`,e),{}}}},5902(t,e,r){r.a(t,async(t,a)=>{try{r.d(e,{p:()=>g});var s=r(7140),n=r(3228),o=r(3696),i=r(5822).V,c=t([n]),u=c.then?(await c)():c;n=u[0];const{getGroupPastChats:l}=await i("@scripts/groupChats"),{getEntitiesList:p,eventSource:h,event_types:E,getPastCharacterChats:d}=await i("@script"),_=[{name:"User Settings",id:"#user-settings-button"},{name:"Profile",id:"#sys-settings-button"},{name:"Account",id:"#ai-config-button"}],T=(t,e)=>{switch(e.type){case"SET_OPEN":return{...t,open:e.open};case"REFRESH_START":return{...t,isLoadingChats:!0};case"REFRESH_SUCCESS":return{...t,chats:e.chats,entities:e.entities,isLoadingChats:!1};case"REFRESH_FAILURE":return console.error("Failed to refresh sidebar chats:",e.error),{...t,isLoadingChats:!1};case"SET_ICONS":return{...t,icons:e.icons};case"SET_INITIAL_LOAD":return{...t,isInitialLoad:e.isInitialLoad};case"SET_CONTEXT":return{...t,context:e.context};default:return t}},C={open:!0,entities:[],chats:[],icons:[],isLoadingChats:!0,isInitialLoad:!0,context:"recent"},g=()=>{const[t,e]=(0,s.useReducer)(T,C),r=(0,s.useRef)(!1),a=(0,s.useRef)(!1),i=(0,s.useRef)(t.open);(0,s.useEffect)(()=>{i.current=t.open},[t.open]);const c=(0,s.useCallback)(t=>{e({type:"SET_OPEN",open:t})},[]),u=(0,s.useCallback)(async(t=!1)=>{if(!r.current||t){e({type:"SET_CONTEXT",context:t?"recent":"chat"}),r.current=!0,e({type:"REFRESH_START"});try{const{characterId:r,groupId:a}=SillyTavern.getContext(),s=null!=a,o=null!=r&&Number(r)>=0,i=p({doFilter:!0,doSort:!0});let c=[];s?c=await l(a.toString()):o?c=await d():t&&(c=await(0,n.r8)(i)),e({type:"REFRESH_SUCCESS",chats:c,entities:i})}catch(t){e({type:"REFRESH_FAILURE",error:t})}finally{r.current=!1,a.current&&(a.current=!1),e({type:"SET_INITIAL_LOAD",isInitialLoad:!1})}}else a.current=!0},[]),g=(0,s.useCallback)(()=>{u(!0)},[u]),S=(0,s.useCallback)(()=>{u()},[]),A=(0,s.useCallback)(()=>{const t=$("#top-settings-holder");if(!t.length)return;const r=[];t.children().each((t,e)=>{const a=$(e),s=`#${a.attr("id")}`,n=a.find(".drawer-icon");r.push({className:n.attr("class")||"",title:n.attr("title")||a.find(".drawer-toggle").attr("title")||"",showInProfile:_.some(t=>t.id===s),id:s})}),t.attr("style","display: none !important;"),e({type:"SET_ICONS",icons:r})},[]);return(0,s.useEffect)(()=>{A();const t=()=>{i.current||window.innerWidth>1e3&&c(!0)};h.on(E.APP_READY,g),h.on(E.CHAT_CHANGED,u),h.on(E.CHAT_DELETED,u),h.on(E.CHAT_CREATED,u),h.on(E.SETTINGS_UPDATED,t),h.on(E.CHARACTER_EDITED,u),h.on(E.CHARACTER_RENAMED,u),h.on(o.V.ENTITY_CHANGED,g),h.on(o.V.HOME_BUTTON_CLICKED,g),h.on(o.V.CHAT_UPDATE,S);const e=$("body");let r=0,a=0;const s=t=>{r=t.clientX??0},n=t=>{a=t.clientX??0},l=t=>{r=t.originalEvent?.touches[0]?.clientX??0},p=t=>{a=t.originalEvent?.touches[0]?.clientX??0},d=()=>{0!==r&&0!==a&&(a>r+100?c(!0):a<r-100&&window.innerWidth<=1e3&&c(!1),r=0,a=0)};return e&&(e.on("pointerdown",s),e.on("pointermove",n),e.on("touchstart",l),e.on("touchmove",p),e.on("touchend pointerup",d)),()=>{h.removeListener(E.APP_READY,u),h.removeListener(E.CHAT_CHANGED,u),h.removeListener(E.CHAT_DELETED,u),h.removeListener(E.CHAT_CREATED,u),h.removeListener(E.SETTINGS_UPDATED,t),h.removeListener(E.CHARACTER_EDITED,u),h.removeListener(E.CHARACTER_RENAMED,u),h.removeListener(o.V.ENTITY_CHANGED,g),h.removeListener(o.V.HOME_BUTTON_CLICKED,g),h.removeListener(o.V.CHAT_UPDATE,S),e&&(e.off("pointerdown",s),e.off("pointermove",n),e.off("touchstart",l),e.off("touchmove",p),e.off("touchend pointerup",d))}},[g,A,u,c]),{...t,setOpen:c}};a()}catch(t){a(t)}},1)}};
//# sourceMappingURL=288.bundle.js.map