export const __webpack_esm_id__=288;export const __webpack_esm_ids__=[288];export const __webpack_esm_modules__={1752(t,e,r){r.d(e,{SQ:()=>i,YL:()=>o});var n=r(5656),a=r(7140);const s=(0,a.createContext)(void 0),o=({children:t})=>{const[e,r]=(0,a.useState)(""),o=(0,a.useCallback)(t=>{r(t)},[]);return(0,n.jsx)(s.Provider,{value:{searchQuery:e,setSearchQuery:o},children:t})},i=()=>{const t=(0,a.useContext)(s);if(!t)throw new Error("useSearch cannot be used outside of SearchProvider");return t}},3228(t,e,r){r.a(t,async(t,n)=>{try{r.d(e,{eS:()=>D,r8:()=>v,yG:()=>A,yN:()=>I});var a=r(5822).V;const{characters:s,getRequestHeaders:o,getThumbnailUrl:i,system_avatar:c,openCharacterChat:u,setActiveCharacter:h,setActiveGroup:l,getCurrentChatId:d,saveSettingsDebounced:p,selectCharacterById:C}=await a("@script"),{groups:g,openGroupById:_,openGroupChat:E}=await a("@scripts/groupChats"),{sortMoments:T,timestampToMoment:m,isDataURL:f}=await a("@scripts/utils");async function v(t,e=20){const r=await fetch("/api/chats/recent",{method:"POST",headers:o(),body:JSON.stringify({max:e})});if(!r.ok)return console.warn("Failed to fetch recent character chats"),[];const n=await r.json();if(!Array.isArray(n)||0===n.length)return[];const a=n.sort((t,e)=>T(m(t.last_mes),m(e.last_mes))).map(t=>({chat:t,character:s.find(e=>e.avatar===t.avatar),group:g.find(e=>e.id===t.group)})).filter(t=>t.character||t.group).filter(e=>{if(!t||0===t.length)return!0;return!!t.find(t=>e.character&&"character"===t.type&&t.item.avatar.toString()===e.character.avatar?.toString()||e.group&&"group"===t.type&&t.id.toString()===e.group.id.toString())});return a.forEach(({chat:t,character:e,group:r},n)=>{const a=m(t.last_mes);t.char_name=e?.name||r?.name||"",t.date_short=a.format("l"),t.date_long=a.format("LL LT"),t.chat_name=t.file_name.replace(".jsonl",""),t.char_thumbnail=e?i("avatar",e?.avatar??""):c,t.is_group=!!r,t.hidden=n>=15,t.avatar=t.avatar||"",t.group=t.group||"",t.char_id=e?s.indexOf(e):void 0}),a.map(t=>t.chat)}const A=async(t,e)=>{try{if(await C(t),h(t),p(),d()===e)return;await u(e)}catch(t){console.error("Error selecting character:",t)}},D=async({group:t,chat_id:e,id:r})=>{try{if(!t&&!r)return;const n=r||t?.id.toString()||"";if(!n)return;if(await _(n),l(n),p(),!e||d()===e)return;await E(n,e)}catch(t){console.error("Error selecting group:",t)}},I=({chat:t,charId:e,groupId:r})=>{if(t&&t?.avatar)return i("avatar",t?.avatar);if(e||r||(e=SillyTavern.getContext().characterId,r=SillyTavern.getContext().groupId),null!=r){return SillyTavern.getContext().groups.find(t=>t.id.toString()===r.toString()).avatar_url}const n="string"==typeof e?parseInt(e):e??-1,a=SillyTavern.getContext().characters[n];return a?i("avatar",a.avatar||""):c};n()}catch(S){n(S)}},1)},3696(t,e,r){r.d(e,{V:()=>n});const n={HOME_BUTTON_CLICKED:"DISCORDIA_HOME_BUTTON_CLICKED",ENTITY_DELETED:"DISCORDIA_ENTITY_DELETED",CHAT_UPDATE:"DISCORDIA_CHAT_UPDATE",ICONS_UPDATE:"DISCORDIA_ICONS_UPDATE",ENTITIES_LENGTH_CHANGED:"DISCORDIA_ENTITIES_LENGTH_CHANGED",CHAT_SWITCH_PENDING:"DISCORDIA_CHAT_SWITCH_PENDING"}},5288(t,e,r){r.a(t,async(t,n)=>{try{r.r(e),r.d(e,{App:()=>p,default:()=>C});var a=r(5656),s=r(7140),o=r(5219),i=r(5902),c=r(1752),u=r(7325),h=t([i]),l=h.then?(await h)():h;i=l[0];const d=(0,s.lazy)(()=>r.e(745).then(r.bind(r,1745))),p=()=>{const{open:t,setOpen:e,entities:r,chats:n,icons:s,isLoadingChats:h,hasActiveContext:l}=(0,i.p)();return(0,o.createPortal)((0,a.jsx)(c.YL,{children:(0,a.jsx)(d,{open:t,setOpen:e,entities:r,chats:n,icons:s,isLoadingChats:h,hasActiveContext:l})}),u.o)},C=p;n()}catch(t){n(t)}})},5822(t,e,r){r.d(e,{V:()=>o});let n=null,a=!1;const s=(t,e)=>e?t.startsWith("../")?`../../../../../public/${t.slice(3)}`:`../../../../../public/scripts/${t}`:`../../../../${t}`,o=async t=>{a&&null!==n||await(async()=>{if(a)return;let t=!1;try{const e="../../../../../script.js",r=await import(e);r||Object.keys(r).length||(t=!0)}catch{t=!0}n={"@script":s("../script.js",t),"@scripts/groupChats":s("group-chats.js",t),"@scripts/utils":s("utils.js",t),"@scripts/welcomeScreen":s("welcome-screen.js",t),"@scripts/personas":s("personas.js",t),"@scripts/chats":s("chats.js",t),"@scripts/powerUser":s("power-user.js",t),"@scripts/extensions":s("extensions.js",t),"@scripts/worldInfo":s("world-info.js",t),"@scripts/naiSettings":s("nai-settings.js",t),"@scripts/openai":s("openai.js",t),"@scripts/kaiSettings":s("kai-settings.js",t),"@scripts/horde":s("horde.js",t),"@scripts/textGenSettings":s("textgen-settings.js",t),"@scripts/presetManager":s("preset-manager.js",t),"@scripts/secrets":s("secrets.js",t)},a=!0,console.log(`[SillyTavern-Discordia] Running as ${t?"local":"global"} extension.`)})();try{const e=n[t]||t;return await import(e)}catch(e){return console.error(`Error importing ${t} (${n[t]}):`,e),{}}}},5902(t,e,r){r.a(t,async(t,n)=>{try{r.d(e,{p:()=>_});var a=r(7140),s=r(3228),o=r(3696),i=r(5822).V,c=t([s]),u=c.then?(await c)():c;s=u[0];const{getGroupPastChats:h}=await i("@scripts/groupChats"),{getEntitiesList:l,eventSource:d,event_types:p,getPastCharacterChats:C}=await i("@script"),g=[{name:"Backgrounds",id:"#backgrounds-button"},{name:"Persona Management",id:"#persona-management-button"},{name:"Character Selector",id:"#rightNavHolder"},{name:"Extensions Settings",id:"#extensions-settings-button"},{name:"Advanced Formatting",id:"#advanced-formatting-button"},{name:"World Info",id:"#WI-SP-button"}],_=()=>{const t=(0,a.useRef)("recent"),e=(0,a.useRef)(null),r=(0,a.useRef)(!1),n=(0,a.useRef)(!1),[i,c]=(0,a.useState)({open:!1,entities:[],chats:[],icons:[],isLoadingChats:!0}),u=(0,a.useCallback)(t=>{c(e=>({...e,open:t}))},[]),_=(0,a.useCallback)(async(a=!1)=>{if(e.current)return r.current=!0,n.current=n.current||a,e.current;c(t=>t.isLoadingChats?t:{...t,isLoadingChats:!0});const{characterId:o,groupId:i}=SillyTavern.getContext(),u=null!=i,d=null!=o&&Number(o)>=0,p=l({doFilter:!0,doSort:!0});return e.current=(async()=>{if(u){const e=await h(i.toString());return t.current="context",void c(t=>t.chats===e&&t.entities===p?{...t,isLoadingChats:!1}:{...t,chats:e,entities:p,isLoadingChats:!1})}if(d){const e=await C();return t.current="context",void c(t=>t.chats===e&&t.entities===p?{...t,isLoadingChats:!1}:{...t,chats:e,entities:p,isLoadingChats:!1})}if(a||"context"!==t.current){const e=await(0,s.r8)(p);t.current="recent",c(t=>t.chats===e&&t.entities===p&&t.open?{...t,isLoadingChats:!1}:{...t,chats:e,entities:p,open:!0,isLoadingChats:!1})}else c(t=>({...t,entities:p,isLoadingChats:!1}))})().catch(t=>{console.error("Error updating chat data:",t),c(t=>({...t,entities:p,isLoadingChats:!1}))}).finally(async()=>{if(e.current=null,r.current){const t=n.current;r.current=!1,n.current=!1,await _(t)}}),e.current},[]),E=(0,a.useCallback)(()=>{_(!0)},[_]),T=(0,a.useCallback)(()=>{_(!0)},[_]),m=(0,a.useCallback)(()=>{t.current="context"},[]),f=(0,a.useCallback)(()=>{const t=$("#top-settings-holder");if(!t.length)return;const e=[];t.children().each((t,r)=>{const n=$(r),a=`#${n.attr("id")}`,s=n.find(".drawer-icon");e.push({className:s.attr("class")||"",title:s.attr("title")||n.find(".drawer-toggle").attr("title")||"",showInProfile:!g.some(t=>t.id===a),id:a})}),t.attr("style","display: none !important;"),c(t=>({...t,icons:e}))},[]);return(0,a.useEffect)(()=>{f();const t=()=>{window.innerWidth>1e3&&!i.open&&u(!0)};d.on(p.APP_READY,_),d.on(p.CHAT_CHANGED,_),d.on(p.CHAT_DELETED,_),d.on(p.CHAT_CREATED,_),d.on(p.SETTINGS_UPDATED,t),d.on(p.CHARACTER_EDITED,_),d.on(p.CHARACTER_RENAMED,_),d.on(o.V.ENTITIES_LENGTH_CHANGED,T),d.on(o.V.HOME_BUTTON_CLICKED,E),d.on(o.V.CHAT_SWITCH_PENDING,m);const e=$("body");let r=0,n=0;const a=t=>{r=t.clientX??0},s=t=>{n=t.clientX??0},c=t=>{r=t.originalEvent?.touches[0]?.clientX??0},h=t=>{n=t.originalEvent?.touches[0]?.clientX??0},l=()=>{0!==r&&0!==n&&(n>r+100?u(!0):n<r-100&&window.innerWidth<=1e3&&u(!1),r=0,n=0)};return e&&(e.on("pointerdown",a),e.on("pointermove",s),e.on("touchstart",c),e.on("touchmove",h),e.on("touchend pointerup",l)),()=>{d.removeListener(p.APP_READY,_),d.removeListener(p.CHAT_CHANGED,_),d.removeListener(p.CHAT_DELETED,_),d.removeListener(p.CHAT_CREATED,_),d.removeListener(p.SETTINGS_UPDATED,t),d.removeListener(p.CHARACTER_EDITED,_),d.removeListener(p.CHARACTER_RENAMED,_),d.removeListener(o.V.ENTITIES_LENGTH_CHANGED,T),d.removeListener(o.V.HOME_BUTTON_CLICKED,E),d.removeListener(o.V.CHAT_SWITCH_PENDING,m),e&&(e.off("pointerdown",a),e.off("pointermove",s),e.off("touchstart",c),e.off("touchmove",h),e.off("touchend pointerup",l))}},[f,_,u,E,m]),{...i,setOpen:u,hasActiveContext:"context"===t.current,refreshChats:_}};n()}catch(t){n(t)}},1)}};
//# sourceMappingURL=288.bundle.js.map