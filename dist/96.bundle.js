"use strict";(self.webpackChunkst_discordia=self.webpackChunkst_discordia||[]).push([[96],{96:(t,e,a)=>{a.a(t,async(t,r)=>{try{a.r(e),a.d(e,{default:()=>f});var n=a(363),s=a(675),c=a(257).V,i=t([s]),o=i.then?(await i)():i;s=o[0];const l=n.lazy(()=>a.e(812).then(a.bind(a,812))),h=n.lazy(()=>a.e(146).then(a.bind(a,146))),u=n.lazy(()=>a.e(476).then(a.bind(a,476))),{getGroupPastChats:d}=await c("@scripts/groupChats"),{getEntitiesList:m,eventSource:p,event_types:g,getPastCharacterChats:v}=await c("@script"),f=()=>{const t=[{name:"Backgrounds",id:"#backgrounds-button"},{name:"Persona Management",id:"#persona-management-button"},{name:"Character Selector",id:"#rightNavHolder"},{name:"Extensions Settings",id:"#extensions-settings-button"},{name:"Advanced Formatting",id:"#advanced-formatting-button"},{name:"World Info",id:"#WI-SP-button"}],[e,a]=(0,n.useState)({open:!0,entities:[],chats:[],icons:[]});n.useEffect(()=>{i(),c(),p.on(g.APP_READY,f),p.on("chat_id_changed",r),p.on(g.CHAT_DELETED,r),p.on(g.CHAT_CREATED,r)},[]);const r=async()=>{const{characterId:t,groupId:e}=SillyTavern.getContext();null==e?void 0!==t&&parseInt(t)>=0?v().then(t=>{a(e=>({...e,chats:t??[]}))}):(0,s.r8)().then(t=>{a(e=>({...e,chats:t}))}):d(e.toString()).then(t=>{a(e=>({...e,chats:t??[]}))})},c=()=>{const t=$("body");if(!t)return;let e=0,a=0;t.on("pointerdown",t=>{e=t.clientX??0}),t.on("pointermove",t=>{a=t.clientX??0}),t.on("touchstart",t=>{e=t.originalEvent?.touches[0]?.clientX??0}),t.on("touchmove",t=>{a=t.originalEvent?.touches[0]?.clientX??0}),t.on("touchend pointerup",()=>{if(a>e+100)o(!0);else if(a<e-100){if(window.innerWidth>1e3)return;o(!1)}})},i=()=>{const e=$("#top-settings-holder");if(!e)return null;const r=[];e.children().each((e,a)=>{const n=$(a),s=`#${n.attr("id")}`,c=n.find(".drawer-icon");r.push({className:c.attr("class")||"",title:c.attr("title")||n.find(".drawer-toggle").attr("title")||"",showInProfile:!t.some(t=>t.id===s),id:s})}),e.attr("style","display: none !important;"),a(t=>({...t,icons:r}))},o=t=>{a(e=>({...e,open:t}))},f=()=>{(0,s.r8)().then(t=>{a(e=>({...e,chats:t}))});const t=m({doFilter:!0,doSort:!0});a(e=>({...e,entities:t}))};if(e.open){const{characterId:t,groupId:a}=SillyTavern.getContext();return n.createElement("div",{id:"sidebar-container"},n.createElement("div",{id:"server-container"},n.createElement(u,{entities:e.entities,setOpen:o,onHomeClick:f}),n.createElement(h,{title:t||a?"Chats":"Recent Chats",icons:e.icons,chats:e.chats,setOpen:o})),n.createElement("div",{id:"user-container"},n.createElement(l,{avatar:null,icons:e.icons})))}return null};r()}catch(t){r(t)}},1)},257:(t,e,a)=>{a.d(e,{V:()=>n});const r={"@script":"../../../../../script.js","@scripts/groupChats":"../../../../group-chats.js","@scripts/utils":"../../../../utils.js","@scripts/welcomeScreen":"../../../../welcome-screen.js","@scripts/personas":"../../../../personas.js","@scripts/chats":"../../../../chats.js","@scripts/powerUser":"../../../../power-user.js","@scripts/extensions":"../../../../extensions.js"},n=async t=>{try{const e=r[t]||t;return await import(e)}catch(e){return console.error(`Error importing ${t} (${r[t]}):`,e),{}}}},675:(t,e,a)=>{a.a(t,async(t,r)=>{try{a.d(e,{cx:()=>S,eS:()=>I,r8:()=>b,yG:()=>A});var n=a(363),s=a(257).V;const{characters:c,getRequestHeaders:i,getThumbnailUrl:o,system_avatar:l,default_avatar:h,openCharacterChat:u,setActiveCharacter:d,setActiveGroup:m,getCurrentChatId:p,saveSettingsDebounced:g,selectCharacterById:v}=await s("@script"),{groups:f,openGroupById:y,openGroupChat:_}=await s("@scripts/groupChats"),{sortMoments:E,timestampToMoment:w,isDataURL:C}=await s("@scripts/utils");async function b(){const t=await fetch("/api/chats/recent",{method:"POST",headers:i(),body:JSON.stringify({max:15})});if(!t.ok)return console.warn("Failed to fetch recent character chats"),[];const e=await t.json();if(!Array.isArray(e)||0===e.length)return[];const a=e.sort((t,e)=>E(w(t.last_mes),w(e.last_mes))).map(t=>({chat:t,character:c.find(e=>e.avatar===t.avatar),group:f.find(e=>e.id===t.group)})).filter(t=>t.character||t.group);return a.forEach(({chat:t,character:e,group:a},r)=>{const n=w(t.last_mes);t.char_name=e?.name||a?.name||"",t.date_short=n.format("l"),t.date_long=n.format("LL LT"),t.chat_name=t.file_name.replace(".jsonl",""),t.char_thumbnail=e?o("avatar",e.avatar):l,t.is_group=!!a,t.hidden=r>=10,t.avatar=t.avatar||"",t.group=t.group||"",t.char_id=e?c.indexOf(e):void 0}),a.map(t=>t.chat)}function S(t){if(!t)return n.createElement("img",{src:h});if(e=t.avatar_url,0!==Object.keys(e).length&&(C(e)||e&&(e.startsWith("user")||e.startsWith("/user"))))return n.createElement("div",{className:"avatar",title:`[Group] ${t.name}`},n.createElement("img",{src:t.avatar_url}));var e;const a=[];if(t&&Array.isArray(t.members)&&t.members.length)for(const e of t.members){const t=c.findIndex(t=>t.avatar===e);if(-1!==t&&"none"!==c[t]?.avatar){const e=o("avatar",c[t]?.avatar||h);a.push(e)}if(4===a.length)break}const r=a.length;if(r>=1&&r<=4){const e=[];for(let t=0;t<r;t++){const r=n.createElement("img",{className:`img_${t+1}`,src:a[t]});e.push(r)}return n.createElement("div",{id:"group_avatars_template",className:`collage_${r} group-avatar`,title:`[Group] ${t.name}`},...e)}if(0===r)return n.createElement("div",{className:"missing-avatar fa-solid fa-user-slash"});return n.createElement("div",{id:"group_avatars_template",className:"collage_1 group-avatar",title:`[Group] ${t.name}`},n.createElement("img",{className:"img_1",src:l}))}const A=async(t,e)=>{try{if(await v(t),d(t),g(),p()===e)return;await u(e)}catch(t){console.error("Error selecting character:",t)}},I=async(t,e)=>{try{const a=t.id.toString();if(await y(a),m(a),g(),!e||p()===e)return;await _(a,e)}catch(t){console.error("Error selecting group:",t)}};r()}catch(j){r(j)}},1)}}]);
//# sourceMappingURL=96.bundle.js.map