export const __webpack_esm_id__=395;export const __webpack_esm_ids__=[395];export const __webpack_esm_modules__={391:(t,e,a)=>{a.a(t,async(t,r)=>{try{a.d(e,{p:()=>m});var n=a(363),o=a(675),s=a(257).V,i=t([o]),c=i.then?(await i)():i;o=c[0];const{getGroupPastChats:l}=await s("@scripts/groupChats"),{getEntitiesList:u,eventSource:d,event_types:h,getPastCharacterChats:p}=await s("@script"),m=t=>{const[e,a]=(0,n.useState)({open:!1,entities:[],chats:[],icons:[]}),r=(0,n.useCallback)(t=>{a(e=>({...e,open:t}))},[]),s=(0,n.useCallback)(async()=>{const{characterId:t,groupId:e}=SillyTavern.getContext();let r=[];try{if(null!==e)r=await l(e.toString());else if(void 0!==t&&parseInt(t)>=0)r=await p();else{const t=u({doFilter:!0,doSort:!0});r=await(0,o.r8)(t)}}catch(t){console.error("Error updating chat data:",t)}a(t=>({...t,chats:r??[]}))},[]),i=(0,n.useCallback)(async()=>{const t=u({doFilter:!0,doSort:!0}),e=await(0,o.r8)(t);a(a=>({...a,chats:e,entities:t,open:!0}))},[]),c=(0,n.useCallback)(()=>{const e=$("#top-settings-holder");if(!e.length)return;const r=[];e.children().each((e,a)=>{const n=$(a),o=`#${n.attr("id")}`,s=n.find(".drawer-icon");r.push({className:s.attr("class")||"",title:s.attr("title")||n.find(".drawer-toggle").attr("title")||"",showInProfile:!t.some(t=>t.id===o),id:o})}),e.attr("style","display: none !important;"),a(t=>({...t,icons:r}))},[t]);return(0,n.useEffect)(()=>{c();const t=()=>{window.innerWidth>1e3&&!e.open&&r(!0)};d.on(h.APP_READY,i),d.on(h.CHAT_CHANGED,s),d.on(h.CHAT_DELETED,s),d.on(h.CHAT_CREATED,s),d.on(h.SETTINGS_UPDATED,t);const a=$("body");let n=0,o=0;const l=t=>{n=t.clientX??0},u=t=>{o=t.clientX??0},p=t=>{n=t.originalEvent?.touches[0]?.clientX??0},m=t=>{o=t.originalEvent?.touches[0]?.clientX??0},g=()=>{0!==n&&0!==o&&(o>n+100?r(!0):o<n-100&&window.innerWidth<=1e3&&r(!1),n=0,o=0)};return a&&(a.on("pointerdown",l),a.on("pointermove",u),a.on("touchstart",p),a.on("touchmove",m),a.on("touchend pointerup",g)),()=>{d.removeListener(h.APP_READY,i),d.removeListener(h.CHAT_CHANGED,s),d.removeListener(h.CHAT_DELETED,s),d.removeListener(h.CHAT_CREATED,s),d.removeListener(h.SETTINGS_UPDATED,t),a&&(a.off("pointerdown",l),a.off("pointermove",u),a.off("touchstart",p),a.off("touchmove",m),a.off("touchend pointerup",g))}},[]),{...e,setOpen:r}};r()}catch(t){r(t)}},1)},395:(t,e,a)=>{a.a(t,async(t,r)=>{try{a.r(e),a.d(e,{App:()=>d,default:()=>h});var n=a(363),o=a(841),s=a(391),i=a(402),c=t([s,i]);[s,i]=c.then?(await c)():c;const l=n.lazy(()=>a.e(96).then(a.bind(a,96))),u=[{name:"Backgrounds",id:"#backgrounds-button"},{name:"Persona Management",id:"#persona-management-button"},{name:"Character Selector",id:"#rightNavHolder"},{name:"Extensions Settings",id:"#extensions-settings-button"},{name:"Advanced Formatting",id:"#advanced-formatting-button"},{name:"World Info",id:"#WI-SP-button"}],d=()=>{const{open:t,setOpen:e,entities:a,chats:r,icons:c}=(0,s.p)(u);return(0,o.createPortal)(n.createElement(l,{open:t,setOpen:e,entities:a,chats:r,icons:c}),i.o)},h=d;r()}catch(t){r(t)}})},675:(t,e,a)=>{a.a(t,async(t,r)=>{try{a.d(e,{cx:()=>T,eS:()=>A,r8:()=>S,yG:()=>b,yN:()=>I});var n=a(363),o=a(257).V;const{characters:s,getRequestHeaders:i,getThumbnailUrl:c,system_avatar:l,default_avatar:u,openCharacterChat:d,setActiveCharacter:h,setActiveGroup:p,getCurrentChatId:m,saveSettingsDebounced:g,selectCharacterById:v}=await o("@script"),{groups:f,openGroupById:_,openGroupChat:y}=await o("@scripts/groupChats"),{sortMoments:E,timestampToMoment:C,isDataURL:w}=await o("@scripts/utils");async function S(t,e=20){const a=await fetch("/api/chats/recent",{method:"POST",headers:i(),body:JSON.stringify({max:e})});if(!a.ok)return console.warn("Failed to fetch recent character chats"),[];const r=await a.json();if(!Array.isArray(r)||0===r.length)return[];const n=r.sort((t,e)=>E(C(t.last_mes),C(e.last_mes))).map(t=>({chat:t,character:s.find(e=>e.avatar===t.avatar),group:f.find(e=>e.id===t.group)})).filter(t=>t.character||t.group).filter(e=>{if(!t||0===t.length)return!0;return!!t.find(t=>e.character&&"character"===t.type&&t.item.avatar.toString()===e.character.avatar.toString()||e.group&&"group"===t.type&&t.id.toString()===e.group.id.toString())});return n.forEach(({chat:t,character:e,group:a},r)=>{const n=C(t.last_mes);t.char_name=e?.name||a?.name||"",t.date_short=n.format("l"),t.date_long=n.format("LL LT"),t.chat_name=t.file_name.replace(".jsonl",""),t.char_thumbnail=e?c("avatar",e.avatar):l,t.is_group=!!a,t.hidden=r>=15,t.avatar=t.avatar||"",t.group=t.group||"",t.char_id=e?s.indexOf(e):void 0}),n.map(t=>t.chat)}function T(t){if(!t)return n.createElement("img",{src:u});if(e=t.avatar_url,0!==Object.keys(e).length&&(w(e)||e&&(e.startsWith("user")||e.startsWith("/user"))))return n.createElement("div",{className:"avatar",title:`[Group] ${t.name}`},n.createElement("img",{loading:"lazy",src:t.avatar_url}));var e;const a=[];if(t&&Array.isArray(t.members)&&t.members.length)for(const e of t.members){const t=s.findIndex(t=>t.avatar===e);if(-1!==t&&"none"!==s[t]?.avatar){const e=c("avatar",s[t]?.avatar||u);a.push(e)}if(4===a.length)break}const r=a.length;if(r>=1&&r<=4){const e=[];for(let t=0;t<r;t++){const r=n.createElement("img",{className:`img_${t+1}`,src:a[t]});e.push(r)}return n.createElement("div",{id:"group_avatars_template",className:`collage_${r} group-avatar`,title:`[Group] ${t.name}`},...e)}if(0===r)return n.createElement("div",{className:"missing-avatar fa-solid fa-user-slash"});return n.createElement("div",{id:"group_avatars_template",className:"collage_1 group-avatar",title:`[Group] ${t.name}`},n.createElement("img",{className:"img_1",src:l}))}const b=async(t,e)=>{try{if(await v(t),h(t),g(),m()===e)return;await d(e)}catch(t){console.error("Error selecting character:",t)}},A=async({group:t,chat_id:e,id:a})=>{try{if(!t&&!a)return;const r=a||t?.id.toString()||"";if(!r)return;if(await _(r),p(r),g(),!e||m()===e)return;await y(r,e)}catch(t){console.error("Error selecting group:",t)}},I=({chat:t,charId:e,groupId:a})=>{if(t&&t?.avatar)return c("avatar",t?.avatar);if(e||a||(e=SillyTavern.getContext().characterId,a=SillyTavern.getContext().groupId),null!=a){return SillyTavern.getContext().groups.find(t=>t.id.toString()===a.toString()).avatar_url}const r="string"==typeof e?parseInt(e):e??-1,n=SillyTavern.getContext().characters[r];return n?c("avatar",n.avatar):l};r()}catch(D){r(D)}},1)}};
//# sourceMappingURL=395.bundle.js.map