export const __webpack_esm_id__=13;export const __webpack_esm_ids__=[13];export const __webpack_esm_modules__={6013(e,t,r){r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{App:()=>d,default:()=>h});var a=r(5656),o=r(7140),s=r(5219),i=r(6853),c=r(6916),u=r(5168),l=e([i,u]);[i,u]=l.then?(await l)():l;const E=(0,o.lazy)(()=>r.e(734).then(r.bind(r,8734))),d=()=>{const e=(0,i.p)(),t=(0,o.useMemo)(()=>e,[e.open,e.setOpen,e.entities,e.chats,e.icons,e.isLoadingChats,e.isInitialLoad]);return(0,s.createPortal)((0,a.jsx)(c.YL,{children:(0,a.jsx)(E,{...t})}),u.o)},h=d;n()}catch(e){n(e)}})},6853(e,t,r){r.a(e,async(e,n)=>{try{r.d(t,{p:()=>m});var a=r(7140),o=r(9452),s=r(2711),i=r(3659).V,c=r(9232).f,u=e([o]),l=u.then?(await u)():u;o=l[0];const{getGroupPastChats:E}=await i("@scripts/groupChats"),{getEntitiesList:d,eventSource:h,event_types:_,getPastCharacterChats:p}=await i("@script"),T=[{name:"User Settings",id:"#user-settings-button"},{name:"Profile",id:"#sys-settings-button"},{name:"Account",id:"#ai-config-button"}],C=(e,t)=>{switch(t.type){case"SET_OPEN":return{...e,open:t.open};case"REFRESH_START":return{...e,isLoadingChats:!0};case"REFRESH_SUCCESS":return{...e,...t,isLoadingChats:!1};case"REFRESH_FAILURE":return c.error("Failed to refresh sidebar chats:",t.error),{...e,isLoadingChats:!1};case"SET_ENTITIES":return{...e,entities:t.entities};case"SET_ICONS":return{...e,icons:t.icons};case"SET_INITIAL_LOAD":return{...e,isInitialLoad:t.isInitialLoad};case"SET_CONTEXT":return{...e,context:t.context};default:return e}},S={open:!0,entities:[],chats:[],recentChats:[],icons:[],isLoadingChats:!0,isInitialLoad:!0,context:"recent"},m=()=>{const[e,t]=(0,a.useReducer)(C,S),r=(0,a.useRef)(!1),n=(0,a.useRef)(!1),i=(0,a.useRef)(e.open);(0,a.useEffect)(()=>{i.current=e.open},[e.open]);const u=(0,a.useCallback)(e=>{t({type:"SET_OPEN",open:e})},[]),l=(0,a.useCallback)(()=>{try{const e=d({doFilter:!0,doSort:!0});t({type:"SET_ENTITIES",entities:e})}catch(e){c.error("Failed to refresh characters:",e)}},[]),m=(0,a.useCallback)(async()=>{t({type:"REFRESH_START"});try{const e=await(0,o.r)();t({type:"REFRESH_SUCCESS",recentChats:e})}catch(e){c.error("Failed to refresh recent chats:",e)}},[]),f=(0,a.useCallback)(async(e=!1)=>{if(!r.current||e){t({type:"SET_CONTEXT",context:e?"recent":"chat"}),r.current=!0,t({type:"REFRESH_START"});try{const{characterId:e,groupId:r}=SillyTavern.getContext(),n=null!=r,a=null!=e&&Number(e)>=0;let o=[];n?o=await E(r.toString()):a&&(o=await p()),t({type:"REFRESH_SUCCESS",chats:o})}catch(e){t({type:"REFRESH_FAILURE",error:e})}finally{r.current=!1,n.current&&(n.current=!1,f()),t({type:"SET_INITIAL_LOAD",isInitialLoad:!1})}}else n.current=!0},[]),A=(0,a.useCallback)(async()=>{t({type:"SET_CONTEXT",context:"recent"}),l(),m()},[l,m]),g=(0,a.useCallback)(()=>{l(),f(),m()},[l,f,m]),y=(0,a.useCallback)(()=>{const e=$("#top-settings-holder");if(!e.length)return;const r=e.children().toArray().map(e=>{const t=$(e),r=`#${t.attr("id")}`,n=t.find(".drawer-icon");return{className:n.attr("class")||"",title:n.attr("title")||t.find(".drawer-toggle").attr("title")||"",showInProfile:T.some(e=>e.id===r),id:r}});e.attr("style","display: none !important;"),t({type:"SET_ICONS",icons:r})},[]);return(0,a.useEffect)(()=>{y();const e=()=>{i.current||window.innerWidth>1e3&&u(!0)},t=()=>f();h.on(_.APP_READY,g),h.on(_.CHAT_CHANGED,t),h.on(_.CHAT_DELETED,t),h.on(_.CHAT_CREATED,t),h.on(_.SETTINGS_UPDATED,e),h.on(_.CHARACTER_EDITED,l),h.on(_.CHARACTER_RENAMED,l),h.on(s.V.ENTITY_CHANGED,l),h.on(s.V.HOME_BUTTON_CLICKED,A),h.on(s.V.CHAT_UPDATE,t);const r=$("body");let n=0,a=0;const o=e=>{n=e.clientX??0},c=e=>{a=e.clientX??0},E=e=>{n=e.originalEvent?.touches[0]?.clientX??0},d=e=>{a=e.originalEvent?.touches[0]?.clientX??0},p=()=>{0!==n&&0!==a&&(a>n+100?u(!0):a<n-100&&window.innerWidth<=1e3&&u(!1),n=0,a=0)};return r&&(r.on("pointerdown",o),r.on("pointermove",c),r.on("touchstart",E),r.on("touchmove",d),r.on("touchend pointerup",p)),()=>{h.removeListener(_.APP_READY,g),h.removeListener(_.CHAT_CHANGED,t),h.removeListener(_.CHAT_DELETED,t),h.removeListener(_.CHAT_CREATED,t),h.removeListener(_.SETTINGS_UPDATED,e),h.removeListener(_.CHARACTER_EDITED,l),h.removeListener(_.CHARACTER_RENAMED,l),h.removeListener(s.V.ENTITY_CHANGED,l),h.removeListener(s.V.HOME_BUTTON_CLICKED,A),h.removeListener(s.V.CHAT_UPDATE,t),r&&(r.off("pointerdown",o),r.off("pointermove",c),r.off("touchstart",E),r.off("touchmove",d),r.off("touchend pointerup",p))}},[g,y,f,l,u,A]),{...e,setOpen:u}};n()}catch(e){n(e)}},1)},6916(e,t,r){r.d(t,{SQ:()=>c,YL:()=>i});var n=r(5656),a=r(7140);const o=(0,a.createContext)(void 0),s=SillyTavern.libs.lodash,i=({children:e})=>{const[t,r]=(0,a.useState)(""),i=(0,a.useMemo)(()=>s.debounce(r,300),[]);return(0,n.jsx)(o,{value:{searchQuery:t,setSearchQuery:i},children:e})},c=()=>{const e=(0,a.use)(o);if(!e)throw new Error("useSearch cannot be used outside of SearchProvider");return e}},9452(e,t,r){r.a(e,async(e,n)=>{try{r.d(t,{r:()=>h});var a=r(3659).V,o=r(9232).f;const{characters:s,getRequestHeaders:i,getThumbnailUrl:c,system_avatar:u}=await a("@script"),{groups:l}=await a("@scripts/groupChats"),{sortMoments:E,timestampToMoment:d}=await a("@scripts/utils");async function h(e,t=20){const r=await fetch("/api/chats/recent",{method:"POST",headers:i(),body:JSON.stringify({max:t})});if(!r.ok)return o.warn("Failed to fetch recent character chats"),[];const n=await r.json();if(!Array.isArray(n)||0===n.length)return[];const a=new Map(s.map(e=>[e.avatar,e])),h=new Map(l.map(e=>[e.id.toString(),e])),_=new Set;e&&e.length>0&&e.forEach(e=>{"character"===e.type?_.add(`char:${e.item.avatar}`):"group"===e.type&&_.add(`group:${e.id.toString()}`)});const p=_.size>0;return n.sort((e,t)=>E(d(e.last_mes),d(t.last_mes))).map((e,t)=>{const r=e.avatar?a.get(e.avatar):void 0,n=e.group?h.get(String(e.group)):void 0;if(p&&!r&&!n)return null;if(p){if(!(r&&_.has(`char:${r.avatar}`)||n&&_.has(`group:${n.id}`)))return null}const o=d(e.last_mes);return{...e,char_name:r?.name||n?.name||String(e.group||""),date_short:o.format("l"),date_long:o.format("LL LT"),chat_name:e.file_name.replace(".jsonl",""),char_thumbnail:r?c("avatar",r.avatar??""):u,is_group:Boolean(n||e.group),hidden:t>=15,char_id:r?s.indexOf(r):void 0}}).filter(e=>null!==e)}n()}catch(_){n(_)}},1)}};
//# sourceMappingURL=13.bundle.js.map