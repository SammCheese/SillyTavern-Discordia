export const __webpack_esm_id__=457;export const __webpack_esm_ids__=[345,457,713];export const __webpack_esm_modules__={2332(e,t,a){a.d(t,{A:()=>d});var r=a(5656),n=a(7140);const s=(0,n.memo)(({children:e})=>(0,r.jsx)("div",{className:"p-4 flex-1 overflow-y-auto min-h-0 custom-scrollbar",children:e})),i=(0,n.memo)(({children:e})=>(0,r.jsx)("div",{className:"rounded-b-lg flex shrink-0 justify-end space-x-2 p-4 border-t border-gray-700 w-full bg-base-discordia",children:e}));var o=a(1778);const l=(0,n.memo)(({title:e,onClose:t,children:a,canClose:s=!0})=>{const{closeModal:i}=(0,n.useContext)(o.Vs),l=(0,n.useCallback)(()=>{t&&t(),i()},[t,i]);return(0,r.jsxs)("div",{className:"px-4 py-4 shrink-0 border-b border-gray-700 flex items-center justify-between w-full",children:[(0,r.jsx)("div",{className:"text-lg font-semibold m-0",children:e??a}),(0,r.jsx)("div",{className:"flex items-center",children:s&&(0,r.jsx)("button",{onClick:l,className:"text-gray-400  hover:text-white cursor-pointer focus:outline-none","aria-label":"Close modal",children:"âœ•"})})]})}),c=(0,n.memo)(({children:e,className:t=""})=>(0,r.jsx)("div",{className:`flex flex-col w-full h-full\n        bg-base-discordia rounded-lg shadow-2xl border border-gray-700\n        overflow-hidden ${t}`,children:e}));c.displayName="Modal",c.Header=l,c.Content=s,c.Footer=i;const d=c},4345(e,t,a){a.r(t),a.d(t,{default:()=>s});var r=a(5656),n=a(7140);const s=(0,n.memo)(({placeholder:e="",defaultValue:t="",value:a,label:s="",onChange:i,style:o,disabled:l=!1,id:c="",type:d="text",growHeight:u=!1,maxHeight:m=160})=>{const h=a??t??"",p=(0,n.useRef)(null),f=(0,n.useCallback)(e=>{i(e.target.value)},[i]);return(0,n.useEffect)(()=>{u&&p.current&&(p.current.style.height="auto",p.current.style.height=`${Math.min(p.current.scrollHeight,m)}px`)},[h,u,m]),(0,r.jsxs)("div",{className:"flex flex-col w-full gap-1 ",style:o,children:[s&&(0,r.jsx)("label",{className:"text-sm font-medium mb-1",htmlFor:c,children:s}),u?(0,r.jsx)("textarea",{ref:p,id:c,disabled:l,style:u?{maxHeight:`${m}px`,overflowY:"auto"}:void 0,className:"input-field w-full px-3 py-2 bg-input-bg rounded-md outline outline-input-outline focus:ring-2 focus:ring-input-ring resize-none text-wrap wrap-break-word",placeholder:e,value:h,onChange:f,rows:1}):(0,r.jsx)("input",{contentEditable:u,id:c,disabled:l,className:"input-field w-full px-3 py-2 bg-input-bg rounded-md outline outline-input-outline focus:ring-2 focus:ring-input-ring",placeholder:e,type:d,value:h,onChange:f})]})})},5599(e,t,a){a.d(t,{A:()=>i,m:()=>r});var r,n=a(5656),s=a(7140);!function(e){e.DANGER="danger",e.PRIMARY="primary",e.SECONDARY="secondary",e.TRANSPARENT="transparent"}(r||(r={}));const i=(0,s.memo)(({label:e,onClick:t,children:a,disabled:i=!1,look:o=r.PRIMARY})=>{const l=(0,s.useCallback)(()=>{!i&&t&&t()},[i,t]),c=(0,s.useCallback)(()=>{switch(o){case r.DANGER:return"bg-red-600 hover:bg-red-700 border-red-700";case r.SECONDARY:return"bg-gray-600 hover:bg-gray-700 border-gray-700";case r.PRIMARY:return"hover:bg-blurple-lighter bg-blurple border-blurple";case r.TRANSPARENT:return"bg-transparent hover:border-blurple border-white";default:return"hover:bg-blurple-lighter bg-blurple border-blurple"}},[o]),d=(0,s.useMemo)(()=>c(),[c]);return(0,n.jsx)("button",{className:`px-4 py-2 text-white font-bold border cursor-pointer rounded disabled:opacity-50 ${d}`,onClick:l,disabled:i,children:e||a})})},5864(e,t,a){a.a(e,async(e,r)=>{try{a.d(t,{OW:()=>f,QE:()=>h,_:()=>g,fg:()=>x,t9:()=>b});var n=a(3696),s=a(5822).V;const{getRequestHeaders:i,getCharacters:o,eventSource:l,deleteCharacter:c,closeCurrentChat:d}=await s("@script"),{ensureImageFormatSupported:u}=await s("@scripts/utils");async function m(e){const t=new FormData;if(e.avatar instanceof File){const a=await u(e.avatar);t.append("avatar",a)}else t.append("avatar_url",e.avatar);Object.keys(e).forEach(a=>{const r=e[a];null!=r&&"avatar"!==a&&(Array.isArray(r)?"tags"===a?t.append(a,r.join(",")):r.forEach(e=>t.append(a,String(e))):t.append(a,String(r)))});const a=await fetch("/api/characters/edit",{method:"POST",headers:i({omitContentType:!0}),body:t,cache:"no-cache"});if(!a.ok){const e=await a.text();throw new Error(e||a.statusText)}}function h(e){const t=(t,a)=>e.data&&void 0!==e.data[t]&&""!==e.data[t]?e.data[t]:a&&void 0!==e[a]?e[a]:void 0!==e[t]?e[t]:"",a=t=>e.data?.extensions?.[t]??void 0,r=e.data?.extensions?.depth_prompt??{},n={...e.data?.extensions||{}};delete n.depth_prompt,delete n.talkativeness,delete n.fav,delete n.world;let s=t("tags");"string"==typeof s?s=s.split(",").map(e=>e.trim()).filter(e=>e):Array.isArray(s)||(s=[]);let i=t("alternate_greetings");Array.isArray(i)||(i=[]);const o={ch_name:t("name")||e.name||"",avatar:e.avatar||"none",description:t("description"),personality:t("personality"),scenario:t("scenario"),first_mes:t("first_mes"),mes_example:t("mes_example"),creator_notes:t("creator_notes","creatorcomment"),tags:s,creator:t("creator"),character_version:t("character_version"),system_prompt:t("system_prompt"),post_history_instructions:t("post_history_instructions"),alternate_greetings:i,talkativeness:a("talkativeness")??e.talkativeness??.5,fav:String(a("fav")??e.fav??!1),world:a("world")??e.world??"",depth_prompt_prompt:r.prompt??"",depth_prompt_depth:isNaN(Number(r.depth))?4:Number(r.depth),depth_prompt_role:r.role??"system"};return Object.keys(n).length>0&&(o.extensions=JSON.stringify(n)),o}async function p(e,t){if(!e||!t)throw new Error("Avatar URL and new name are required to rename character.");const a=await fetch("/api/characters/rename",{method:"POST",headers:i(),body:JSON.stringify({avatar_url:e,new_name:t}),cache:"no-cache"});if(!a.ok)throw new Error(`Failed to rename character: ${a.statusText}`);return await a.text()}async function f(e){const t=new FormData;if(e.avatar instanceof File){const a=await u(e.avatar),r=e.avatar.name||"avatar.png";t.append("avatar",a,r)}else"string"==typeof e.avatar&&t.append("avatar_url",e.avatar);Object.keys(e).forEach(a=>{const r=e[a];null!=r&&"avatar"!==a&&(Array.isArray(r)?"tags"===a?t.append(a,r.join(",")):r.forEach(e=>t.append(a,String(e))):t.append(a,String(r)))});const a=await fetch("/api/characters/create",{method:"POST",headers:i({omitContentType:!0}),body:t,cache:"no-cache"});if(!a.ok){const e=await a.text();throw new Error(e||a.statusText)}return await a.text()}async function g(e,t={}){if(!e)throw new Error("Avatar URL is required to delete character.");const{characters:a,characterId:r}=SillyTavern.getContext(),n=a.find(t=>t.avatar?.toString()===e);null!=r&&n&&a[r]===n&&(await d(),await c(e,t),await x())}async function x(){await o(),l.emit(n.V.ENTITIES_LENGTH_CHANGED)}async function b(e,t){const a=SillyTavern.getContext().characters.find(t=>t.avatar?.toString()===e)?.name;if(!a)throw new Error("Original character not found for update.");const r={...t,avatar_url:e};if(await m(r),t.ch_name&&t.ch_name!==a)try{return await p(e,t.ch_name)}catch(e){throw console.error("Edit successful, but Rename failed:",e),e}return await o(),e}r()}catch(v){r(v)}},1)},6264(e,t,a){a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{default:()=>b});var n=a(5656),s=a(7140),i=a(1778),o=a(5599),l=a(4345),c=a(2332),d=a(7713),u=a(5864),m=a(5822).V,h=e([u]),p=h.then?(await h)():h;u=p[0];const{getThumbnailUrl:f}=await m("@script"),{getContext:g}=SillyTavern,x=(0,s.memo)(function({field:e,value:t,onChange:a,...r}){const i=(0,s.useCallback)(t=>{a({[e]:t})},[a,e]);return(0,n.jsx)(l.default,{value:t||"",onChange:i,...r})}),b=({type:e="edit",onClose:t,avatarName:a,onSave:r})=>{const[l,m]=(0,s.useState)(null),[h,p]=(0,s.useState)(null),[b,v]=(0,s.useState)(null),[y,w]=(0,s.useState)(null),C=(0,s.useRef)(null),{closeModal:_}=(0,s.useContext)(i.Vs),j="create"===e,N=(0,s.useMemo)(()=>f("avatar","default_Assistant.png"),[]),k=(0,s.useCallback)(e=>{m(t=>{if(!t)return t;const a={};"name"in e&&(a.name=e.name),"description"in e&&(a.description=e.description),"scenario"in e&&(a.scenario=e.scenario),"personality"in e&&(a.personality=e.personality),"first_mes"in e&&(a.first_mes=e.first_mes),"mes_example"in e&&(a.mes_example=e.mes_example),"creatorcomment"in e&&(a.creator_notes=e.creatorcomment);const r=Object.keys(a).length?{...t.data||{},...a}:t.data;return{...t,...e,data:r}})},[]);(0,s.useEffect)(()=>()=>{b&&b.startsWith("blob:")&&URL.revokeObjectURL(b)},[b]);const S=(0,s.useCallback)(()=>{C.current?.click()},[]),A=(0,s.useCallback)(e=>{const t=e.target.files?.[0];if(t){p(t);const e=URL.createObjectURL(t);v(e)}},[]);(0,s.useEffect)(()=>{if(j)m({name:"",description:"",scenario:"A chat between {{user}} and {{char}}.",first_mes:"",personality:"",creatorcomment:"",data:{}});else{const e=g().characters.find(e=>e.avatar?.toString()===a);if(e){m(e);const t=g().characters.indexOf(e);-1!==t&&w(t),v(f("avatar",a||"default_Assistant.png"))}}},[a,j]);const E=(0,s.useCallback)(async()=>{if(l)try{const e=(0,u.QE)(l);if(h&&(e.avatar=h),j)await(0,u.OW)(e);else{if(!a)return;await(0,u.t9)(a,e)}r&&r(),await(0,u.fg)(),_()}catch(e){console.error("Error saving character:",e)}},[r,y,_,a,l,e,h]),T=(0,s.useCallback)(()=>{t&&t(),_()},[t,_]),R=(0,s.useCallback)(()=>{a&&(0,u._)(a,{deleteChats:!0}).then(async()=>{_()})},[a,_]),H=(0,s.useMemo)(()=>j?"Create":"Save",[j]),I=(0,s.useMemo)(()=>j?"Create Character":"Edit Character",[j]),O=(0,s.useMemo)(()=>!l||""===l.name.trim(),[l]);return(0,n.jsxs)(c.A,{children:[(0,n.jsx)(c.A.Header,{onClose:T,children:I}),(0,n.jsxs)(c.A.Content,{children:[(0,n.jsxs)("div",{id:"avatar-name-edit",className:"flex w-full align-top p-6",children:[(0,n.jsxs)("div",{className:"shrink-0 w-32 flex items-center",children:[(0,n.jsxs)("div",{className:"cursor-pointer  relative group",onClick:S,title:"Click to change avatar",children:[(0,n.jsx)("img",{loading:"lazy",src:b||N,alt:"Avatar",className:"w-32 h-32 rounded-full object-cover border-2 border-gray-700 shrink-0 transition-opacity group-hover:opacity-50 group-hover:border-blue-500"}),(0,n.jsx)("div",{children:(0,n.jsx)("span",{className:"text-sm text-center block mt-2",children:"Change Avatar"})})]}),(0,n.jsx)("input",{type:"file",accept:"image/*",ref:C,className:"hidden",onChange:A})]}),(0,n.jsxs)("div",{className:"grow space-y-2 ms-4 relative top-4",children:[(0,n.jsx)("label",{className:"block text-sm font-medium mb-1",htmlFor:"name",children:"Name"}),(0,n.jsx)(x,{id:"name",field:"name",value:l?.name,onChange:k,placeholder:"Enter character name"})]})]}),(0,n.jsx)(d.default,{title:"Creator Notes",children:(0,n.jsx)("div",{id:"creator-notes-edit",className:"p-3 w-full space-y-2",children:(0,n.jsx)(x,{id:"creator_notes",field:"creatorcomment",value:l?.creatorcomment,onChange:k,growHeight:!0,disabled:!j})})}),(0,n.jsxs)("div",{id:"description-edit",className:"p-3 w-full space-y-2",children:[(0,n.jsx)("label",{className:"block text-sm font-medium mb-1",htmlFor:"description",children:"Description"}),(0,n.jsx)(x,{id:"description",field:"description",value:l?.description,onChange:k,growHeight:!0})]}),(0,n.jsxs)("div",{id:"first-message-edit",className:"p-3 w-full space-y-2",children:[(0,n.jsx)("label",{className:"block text-sm font-medium mb-1",htmlFor:"first_message",children:"First Message"}),(0,n.jsx)(x,{id:"first_message",field:"first_mes",value:l?.first_mes,onChange:k,growHeight:!0})]}),(0,n.jsxs)("div",{id:"scenario-edit",className:"p-3 w-full space-y-2",children:[(0,n.jsx)("label",{className:"block text-sm font-medium mb-1",htmlFor:"scenario",children:"Scenario"}),(0,n.jsx)(x,{id:"scenario",field:"scenario",value:l?.scenario,placeholder:"A chat between {{user}} and {{char}}.",onChange:k,growHeight:!0})]})]}),(0,n.jsxs)(c.A.Footer,{children:[!j&&(0,n.jsx)("div",{className:"grow",children:(0,n.jsx)(o.A,{look:o.m.DANGER,onClick:R,children:"Delete"})}),(0,n.jsx)(o.A,{look:o.m.TRANSPARENT,onClick:T,children:"Cancel"}),(0,n.jsx)(o.A,{onClick:E,disabled:O,children:H})]})]})};r()}catch(e){r(e)}},1)},7713(e,t,a){a.r(t),a.d(t,{Accordion:()=>s,default:()=>i});var r=a(5656),n=a(7140);const s=({title:e,isOpen:t=!1,onToggle:a,children:s,destroyOnClose:i=!1})=>{const[o,l]=(0,n.useState)(t);(0,n.useEffect)(()=>{l(t)},[t]);const c=(0,n.useCallback)(()=>{l(e=>!e),a&&a()},[a]);return(0,r.jsxs)("div",{className:"accordion rounded mb-4 border border-base-discordia-lighter overflow-hidden",children:[(0,r.jsxs)("button",{className:"accordion-header cursor-pointer w-full flex justify-between items-center p-2 bg-accordion-header hover:bg-lighter transition-colors duration-200",onClick:c,children:[(0,r.jsx)("span",{className:"text-lg font-medium",children:e}),(0,r.jsx)("span",{className:"transition-transform duration-200 "+(o?"rotate-180":""),children:(0,r.jsx)("div",{className:"fa fa-chevron-down"})})]}),(0,r.jsx)("div",{className:"accordion-content bg-input-bg transition-all duration-200 "+(o?"block p-4":"hidden"),children:(o||!i)&&s})]})},i=(0,n.memo)(s)},9457(e,t,a){a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{default:()=>S});var n=a(5656),s=a(7140),i=a(7963),o=a(3228),l=a(1752),c=a(7393),d=a(3696),u=a(1778),m=a(6264),h=a(5822).V,p=e([o,m]);[o,m]=p.then?(await p)():p;const f=(0,s.lazy)(()=>a.e(939).then(a.bind(a,939))),g=(0,s.lazy)(()=>a.e(308).then(a.bind(a,6308))),x=(0,s.lazy)(()=>a.e(187).then(a.bind(a,3187))),{getGroupPastChats:b}=await h("@scripts/groupChats"),{getPastCharacterChats:v,characters:y,closeCurrentChat:w,eventSource:C,event_types:_}=await h("@script"),j=(0,s.memo)(function({entity:e,index:t,isSelected:a,style:r,onClick:s}){return(0,n.jsx)("div",{style:r,className:"discord-entity-item character-button w-full h-fit flex justify-center py-1",id:`character-button-${e.id}`,title:e.item?.name||e.id,children:(0,n.jsx)(f,{entity:e,index:t,isSelected:a,onClick:s})})},(e,t)=>e.entity===t.entity&&e.isSelected===t.isSelected&&e.onClick===t.onClick),N=({index:e,style:t,data:a})=>{const{entities:r,selectedIndex:i,handleItemClick:o}=a,{openModal:l}=(0,s.useContext)(u.Vs),c=r[e],d=(0,s.useCallback)(()=>{c&&o(c,e)},[c,o,e]),h=(0,s.useCallback)(()=>{l((0,n.jsx)(m.default,{type:"create"}))},[l]);return c?(0,n.jsx)(j,{index:e,entity:c,style:t,isSelected:i===e,onClick:d}):(0,n.jsx)("div",{style:t,className:"discord-entity-item character-button w-full h-fit flex justify-center py-1",children:(0,n.jsx)(g,{onClick:h})})},k=({entities:e})=>{const[t,a]=(0,s.useState)(null),{searchQuery:r}=(0,l.SQ)(),{openModal:h}=(0,s.useContext)(u.Vs),p=(0,s.useCallback)(async()=>{a(null),await w(),await C.emit(d.V.HOME_BUTTON_CLICKED)},[]),f=(0,s.useCallback)(async(e,t)=>{try{if("group"===e.type){const r=e.id.toString();if(!SillyTavern.getContext().groups.find(e=>e.id.toString()===r))return;C.emit(d.V.CHAT_SWITCH_PENDING),await w();const n=await b(r);await(0,o.eS)({group:e,chat_id:n[0]?.file_id}),a(t)}else{const r=y.findIndex(t=>t.avatar===e?.item?.avatar);if(-1===r)return;C.emit(d.V.CHAT_SWITCH_PENDING),await w();const n=await v(r);await(0,o.yG)(r,n[0]?.file_id),a(t)}}catch(e){console.error("Error selecting entity:",e)}},[]);(0,s.useEffect)(()=>{k()},[e]);const k=(0,s.useCallback)(()=>{const{characterId:t,groupId:r}=SillyTavern.getContext();if(null!=r){const t=e.findIndex(e=>"group"===e.type&&e.id.toString()===r.toString());a(-1!==t?t:null)}else if(null!=t&&parseInt(t)>=0){const r=e.findIndex(e=>"character"===e.type&&e.id.toString()===t.toString());a(-1!==r?r:null)}else a(null)},[e]);(0,s.useEffect)(()=>(C.on(_.CHAT_CHANGED,k),()=>{C.removeListener(_.CHAT_CHANGED,k)}),[k]);const S=(0,s.useMemo)(()=>({entities:e,selectedIndex:t,handleItemClick:f}),[e,t,f]),A=(0,s.useMemo)(()=>{const t=e.map((e,t)=>({entity:e,index:t}));return r?t.filter(({entity:e})=>(e.item?.name||"").toLowerCase().includes(r.toLowerCase())):t},[e,r]),E=(0,s.useCallback)(()=>{h((0,n.jsx)(m.default,{type:"create"}))},[]);return(0,n.jsx)(c.A,{children:(0,n.jsxs)("div",{id:"character-container",children:[(0,n.jsxs)("div",{id:"characters-header",children:[(0,n.jsx)(x,{onClick:p}),(0,n.jsx)("div",{id:"characters-divider",className:"divider"})]}),(0,n.jsx)("div",{id:"characters-list",className:"pt-0.5",children:A.length<50?(0,n.jsxs)(n.Fragment,{children:[A.map(({entity:e,index:a})=>(0,n.jsx)(j,{entity:e,index:a,isSelected:t===a,onClick:f,style:{}},e.id.toString())),(0,n.jsx)("div",{id:"characters-divider",className:"divider"}),(0,n.jsx)(g,{onClick:E})]}):(0,n.jsx)(i.B8,{rowComponent:N,rowCount:A.length+1,rowHeight:60,rowProps:{data:S},style:{width:"100%"},overscanCount:5})})]})})},S=(0,s.memo)(k);r()}catch(e){r(e)}},1)}};
//# sourceMappingURL=457.bundle.js.map